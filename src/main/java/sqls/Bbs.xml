<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
	<mapper namespace="FreeBbs">
	
	<select id="bbslist" parameterType="a.dto.BbsParam" resultType="a.dto.FreePostDto">
		select bbs_seq, user_id, title, content, readcount, likecount, cmtcount, wdate, update_date, del
		from (
			select row_number() over(order by bbs_seq desc) as rnum, bbs_seq, user_id, title, content, readcount, likecount, cmtcount, wdate, update_date, del 
			from FreePost
			<if test="choice != null and choice != '' and search != null and search != '' ">
				<choose>
					<when test="choice=='title'">
						where title like concat('%', #{search}, '%')
					</when>
					<when test="choice=='content'">
						where content like concat('%', #{search}, '%')
					</when>
					<when test="choice=='writer'">
						where user_id = #{search}
					</when>
				</choose>
			</if>
		) a where rnum between #{start} and #{end}
	</select>
	
	<!-- 글의 총수 -->
	<select id="getAllBbs" parameterType="a.dto.BbsParam" resultType="java.lang.Integer">
		select ifnull(count(*),0) 
		from freepost
		<if test="choice != null and choice != '' and search != null and search != '' ">
			<choose>
				<when test="choice=='title'">
					where title like concat('%', #{search}, '%')
				</when>
				<when test="choice=='content'">
					where content like concat('%', #{search}, '%')
				</when>
				<when test="choice=='writer'">
					where user_id = #{search}
				</when>
			</choose>
		</if>
	</select>
		
	<insert id="writeBbs" parameterType="a.dto.FreePostDto">
	    insert into FreePost(user_id, title, content, wdate)
	    values (#{user_id}, #{title}, #{content}, now())
	</insert>
		
	<insert id="multiimg" parameterType="a.dto.BbsImgVO">
	    INSERT INTO multiimg (img_name, img_path, img_type)
	    VALUES (#{img_name}, #{img_path}, #{img_type})
	</insert>
	
	<insert id="img_rel">
	    INSERT INTO img_rel (bbs_seq, img_seq)
	    VALUES (
	        (SELECT MAX(bbs_seq) FROM FreePost),
	        LAST_INSERT_ID()
	    )
	</insert>
	
	<!-- 조회수 증가(중복고려 X) -->
	<update id="increaseReadcount" parameterType="int">	
		UPDATE FreePost SET readcount = readcount + 1 WHERE bbs_seq = #{bbs_seq}
	</update>
	
    <select id="getBbs" parameterType="int" resultType="a.dto.FreePostDto">
        select *
        from FreePost
        WHERE bbs_seq = #{bbs_seq}
    </select>
    
	<select id="getImg" parameterType="int" resultType="a.dto.BbsImgVO">
	    SELECT i.img_seq AS img_seq, i.img_path AS img_path, i.img_name AS img_name
	    FROM MultiImg i
	    JOIN IMG_REL r ON i.img_seq = r.img_seq
	    WHERE r.bbs_seq = #{bbs_seq}
	</select>
<!--     <select id="getImgList" parameterType="int" resultMap="a.dto.BbsImgVO">
	  SELECT mi.img_seq, mi.img_name, mi.img_path, mi.img_type
	  FROM FreePost fp
	  JOIN IMG_REL ir ON fp.bbs_seq = ir.bbs_seq
	  JOIN MultiImg mi ON ir.img_seq = mi.img_seq
	  WHERE fp.bbs_seq = #{bbs_seq}
	</select>  -->


</mapper>